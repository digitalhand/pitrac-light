@startuml
title PiTrac-Light Runtime Architecture (Refactored)

skinparam shadowing false
skinparam backgroundColor white
skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam defaultTextAlignment center

actor "Operator" as user

node "Raspberry Pi OS (arm64)" as pi {
  package "CLI and Operations" {
    [pitrac-cli] as cli
    [RunScripts\n(src/RunScripts/*.sh)] as scripts
  }

  package "Launch Monitor Runtime (C++)" {
    [pitrac_lm\n--system_mode camera1\nFSM + hit detection] as cam1
    [pitrac_lm\n--system_mode camera2\ntriggered capture] as cam2
    [ConfigurationManager\n(JSON + env overrides)] as cfgmgr
    [ActiveMQ IPC Adapter\nproducer + consumer] as ipc
    [Simulator Bridge\nsim/common + sim/gspro] as sim
    [Artifact Writer\nGsUISystem + LoggingTools] as artifactsvc
  }

  database "ActiveMQ Broker\nOpenWire tcp://*:61616\nTopic: Golf.Sim" as amq

  folder "~/.pitrac/config\npitrac.env\nuser_settings.json\ngolf_sim_config.json" as cfg
  folder "~/LM_Shares/Images\n~/PiTracLogs" as files
}

cloud "Simulator PC" as simpc {
  [GSPro] as gspro
}

cloud "Optional External Tools" as external {
  [Golf.Sim topic subscriber\n(OpenWire/CMS)] as sub
}

user --> cli : setup / run / service
user --> scripts : optional direct execution

cli --> cfg : env setup + config init
cli --> amq : broker checks / service control
cli --> cam1 : launch camera1 modes
cli --> cam2 : launch camera2 modes

scripts --> cam1
scripts --> cam2

cam1 --> cfgmgr
cam2 --> cfgmgr
cfgmgr --> cfg : load + persist config values

cam1 --> ipc
cam2 --> ipc
ipc --> amq : publish / consume IPC messages

cam1 --> sim : shot metrics
sim --> gspro : TCP :921

cam1 --> artifactsvc
cam2 --> artifactsvc
artifactsvc --> files : write PNGs + logs

amq --> sub : status / hit / control messages

@enduml
