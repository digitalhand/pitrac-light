@startuml
title Camera 1 Auto-Calibration Flow (Current Runtime)

skinparam shadowing false
skinparam backgroundColor white
skinparam activity {
  BackgroundColor #F8F9FA
  BorderColor #333333
  ArrowColor #333333
  FontColor #111111
}

start

:Ensure runtime prerequisites:\n- pitrac-cli validate env\n- pitrac-cli service broker start;
:Optional image sanity check:\npitrac-cli run still --camera 1;

:Run auto-calibration:\npitrac-cli run auto-calibrate --camera 1;
:CLI launches pitrac_lm with\n--system_mode camera1AutoCalibrate\nand common args;

:pitrac_lm startup:\nload config + init camera + IPC + GPIO;

:Capture multiple samples\n(kNumberPicturesForFocalLengthAverage);
:Compute average focal length;

if (Ball detection / focal length valid?) then (yes)
  :Determine camera angles;
  :Update config tree keys:\n- gs_config.cameras.kCamera1FocalLength\n- gs_config.cameras.kCamera1Angles;
  :Backup current config file;
  :Write updated golf_sim_config.json;
  :Save calibration artifacts\nto logging/image directories;
  :Exit success;
else (no)
  :Abort calibration with error logs;
  :Keep previous effective values;
endif

stop
@enduml
