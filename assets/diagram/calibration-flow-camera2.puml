@startuml
title PiTrac Camera 2 Calibration Flow

skinparam shadowing false
skinparam backgroundColor white
skinparam activity {
  BackgroundColor #F8F9FA
  BorderColor #333333
  ArrowColor #333333
  FontColor #111111
}

start

:User runs calibration script:\nrunAutoCalibrateCam2.sh\nor: pitrac-cli run --mode camera2AutoCalibrate;

:Script sources runPiTracCommon.sh\nto load PITRAC_* environment variables;

if (Single-Pi mode?) then (yes)
  :Start background pitrac_lm:\n--run_single_pi\n--system_mode runCam2ProcessForPi1Processing;
  note right
    Background process provides
    camera2 IPC responder on
    the same Pi.
  end note
  :Wait for background process to initialize;
  :Start foreground pitrac_lm:\n--system_mode camera2AutoCalibrate;
else (no)
  :Run pitrac_lm on camera2 Pi:\n--system_mode camera2AutoCalibrate;
endif

:pitrac_lm performs auto-calibration:\n- Detects calibration target\n- Computes kCamera2FocalLength\n- Computes kCamera2Angles;

if (Calibration successful?) then (yes)
  :Write calibration results\ninto golf_sim_config.json;
  :Save calibration artifact images\nto ~/LM_Shares/Images;
else (no)
  :Log error and exit with\nnon-zero status;
endif

if (Background process running?) then (yes)
  :Terminate camera2 background process;
endif

:Process exits;

:User validates calibration images\nin ~/LM_Shares/Images;

stop
@enduml
