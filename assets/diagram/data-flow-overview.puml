@startuml
title PiTrac Data Flow (Config + Runtime Telemetry)

skinparam shadowing false
skinparam backgroundColor white
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "User / Operator" as User
participant "pitrac-cli (Go)\nor RunScripts (Bash)" as CLI
participant "golf_sim_config.json\n+ environment vars" as CFG
participant "pitrac_lm\n(camera1)" as CAM1
participant "pitrac_lm\n(camera2)" as CAM2
participant "ActiveMQ Broker\nOpenWire :61616" as MQ
participant "GSPro Simulator\nTCP :921" as SIM
participant "Image Directory\n~/LM_Shares/Images" as IMGDIR

== Configuration Flow ==
User -> CLI : pitrac-cli config set <key> <value>\nor edit golf_sim_config.json directly
CLI -> CFG : validate + write config JSON
CLI --> User : success / validation error

== Process Start Flow ==
User -> CLI : pitrac-cli run\nor source runPiTracCommon.sh && runCam1.sh
CLI -> CFG : load config JSON\n+ resolve PITRAC_* env vars
CLI -> CAM2 : spawn pitrac_lm --system_mode camera2\n(starts first or simultaneously)
CLI -> CAM1 : spawn pitrac_lm --system_mode camera1

note over CAM2
  Camera2 initializes IPC,
  enters WaitingForCameraArmMessage,
  idles until Camera1 signals.
end note

== Runtime: Camera-to-Camera IPC ==
CAM1 -> MQ : publish GolfSimIPCMessage\n(msgpack: kRequestForCamera2Image)
MQ -> CAM2 : deliver arm message
CAM2 -> MQ : publish GolfSimIPCMessage\n(msgpack: kCamera2Image + captured frame)
MQ -> CAM1 : deliver camera2 image

== Runtime: Shot Results ==
CAM1 -> CAM1 : ProcessReceivedCam2Image()\nball detection + spin analysis
CAM1 -> SIM : SendResultsToGolfSims()\nJSON over TCP :921
CAM1 -> MQ : publish GolfSimIPCMessage\n(msgpack: kResults)
CAM1 -> IMGDIR : write shot/debug images
CAM2 -> IMGDIR : write capture images

note over MQ
  IPC results on ActiveMQ topic
  are available for any external
  subscriber (monitoring tools, etc.)
end note

== Optional Calibration Flow ==
User -> CLI : runAutoCalibrateCam1.sh\nor runAutoCalibrateCam2.sh
CLI -> CAM1 : pitrac_lm --system_mode camera1AutoCalibrate
CAM1 -> CFG : calibration results written\nto golf_sim_config.json
CAM1 -> IMGDIR : calibration artifact images

@enduml
