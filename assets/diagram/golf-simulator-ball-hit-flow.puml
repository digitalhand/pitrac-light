@startuml
title Ball Hit Flow (Detection -> Camera2 -> Simulator)

skinparam shadowing false
skinparam backgroundColor white
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

participant "Camera1 FSM\n(gs_fsm.cpp)" as FSM
participant "PulseStrobe/GPIO" as STROBE
participant "ActiveMQ\nGolf.Sim topic" as MQ
participant "Camera2 Runtime\n(system_mode camera2)" as CAM2
participant "Cam1 Analysis\nProcessReceivedCam2Image" as ANALYSIS
participant "Simulator Bridge\nGsSimInterface" as SIM
participant "GSPro" as GSPRO
participant "Artifact Writer" as FILES

FSM -> FSM : Ball stabilized\nIncrementShotCounter()
FSM -> MQ : IPC kRequestForCamera2Image
FSM -> STROBE : SendCameraPrimingPulses()
FSM -> MQ : IPC status kBallPlacedAndReadyForHit

FSM -> STROBE : WatchForHitAndTrigger()
STROBE -> CAM2 : external trigger pulse
CAM2 -> MQ : IPC kCamera2Image
MQ -> FSM : camera2 image event
FSM -> ANALYSIS : ProcessReceivedCam2Image()

alt analysis success
  ANALYSIS -> SIM : SendResultsToGolfSims()
  SIM -> GSPRO : TCP JSON :921
  ANALYSIS -> MQ : IPC kResults (hit metrics)
  ANALYSIS -> FILES : save output images/logs
else analysis failed
  ANALYSIS -> MQ : IPC kResults (error)
  ANALYSIS -> FILES : save diagnostics
end

opt camera2 timeout branch
  FSM -> FSM : timeout waiting for camera2 image
  FSM -> MQ : IPC error status
  FSM -> FSM : queue Restart
end

@enduml
