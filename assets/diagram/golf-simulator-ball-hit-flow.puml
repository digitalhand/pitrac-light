@startuml
title Ball Hit Flow (Detection -> Camera2 Capture -> Analysis -> Simulator)

skinparam shadowing false
skinparam backgroundColor white
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

participant "Camera1 FSM\n(gs_fsm.cpp)" as FSM
participant "PulseStrobe/GPIO\n(pulse_strobe.cpp)" as STROBE
participant "ActiveMQ\nGolf.Sim" as MQ
participant "Camera2 Process\n(pitrac_lm camera2)" as CAM2
participant "Cam1 Analysis\nProcessReceivedCam2Image" as ANALYSIS
participant "GSPro Simulator\nTCP :921" as SIM

== Ball Stabilized ==

FSM -> FSM : Ball stabilized\nIncrementShotCounter()
FSM -> MQ : IPC kRequestForCamera2Image
MQ -> CAM2 : ArmCamera2MessageReceived

FSM -> STROBE : SendCameraPrimingPulses()

note right of STROBE
  Waits kCam2SetupPeriodMilliseconds (2s)
  for Camera2 to arm, then sends
  priming pulses at kPrimingPulseFPS.
end note

CAM2 -> CAM2 : WaitForCam2Trigger()\n[blocks on external trigger]

== Hit Detection ==

FSM -> STROBE : WatchForHitAndTrigger()
note right of FSM
  Camera1 watch loop detects ball disappearance,
  then FSM enters BallHitNowWaitingForCam2Image.
end note

STROBE -> CAM2 : external trigger/shutter pulse (GPIO)
CAM2 -> CAM2 : Image captured by libcamera
CAM2 -> MQ : IPC kCamera2Image (captured frame)
MQ -> FSM : Camera2ImageReceived event queued

== Analysis & Results ==

FSM -> ANALYSIS : ProcessReceivedCam2Image()

alt analysis success
  ANALYSIS -> ANALYSIS : Ball detection + spin analysis\n(ball_image_proc / ball_detection modules)
  ANALYSIS -> SIM : SendResultsToGolfSims()\nJSON payload over TCP :921
  ANALYSIS -> MQ : IPC kResults\n(speed, launch angle, spin, carry)
  note right of MQ
    Results published on ActiveMQ topic
    for any external subscriber
    (monitoring, logging, etc.)
  end note
else analysis failed
  ANALYSIS -> MQ : IPC kResults (Error status)
  ANALYSIS -> FSM : log error, continue to next shot
end

FSM -> FSM : BeginWaitingForBallPlaced\n-> WaitingForBall (next shot)

== Timeout Branch ==

opt camera2 image not received within 4s
  FSM -> FSM : CheckForCam2ImageReceived timer fires
  FSM -> FSM : queue Restart\n-> InitializingCamera1System
  note right of FSM
    Late-arriving Camera2ImageReceived
    events are caught by out-of-phase
    handler and safely ignored.
  end note
end

@enduml
