#!/bin/bash
# PiTrac Pre-Commit Hook
# Runs quick checks and unit tests before allowing commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# =============================================================================
# Check 1: Trailing Whitespace
# =============================================================================
echo ""
echo "1ï¸âƒ£  Checking for trailing whitespace..."
if git diff --cached --check; then
    echo -e "${GREEN}âœ… No trailing whitespace${NC}"
else
    echo -e "${RED}âŒ Found trailing whitespace. Please fix before committing.${NC}"
    exit 1
fi

# =============================================================================
# Check 2: Large Files
# =============================================================================
echo ""
echo "2ï¸âƒ£  Checking for large files (>5MB)..."
large_files=$(git diff --cached --name-only | xargs -I {} du -k {} 2>/dev/null | awk '$1 > 5120 {print $2}')
if [ -n "$large_files" ]; then
    echo -e "${YELLOW}âš ï¸  Warning: Large files detected:${NC}"
    echo "$large_files"
    echo -e "${YELLOW}Consider using Git LFS for large binary files${NC}"
fi

# =============================================================================
# Check 3: Compile Check (DISABLED - build on Raspberry Pi)
# =============================================================================
changed_cpp_files=$(git diff --cached --name-only | grep -E '\.(cpp|h|hpp)$' || true)
if [ -n "$changed_cpp_files" ]; then
    echo ""
    echo "3ï¸âƒ£  C++ files changed - build check skipped (build on target device)"
else
    echo ""
    echo "3ï¸âƒ£  No C++ files changed"
fi

# =============================================================================
# Check 4: Run Unit Tests (DISABLED - test on Raspberry Pi)
# =============================================================================
echo ""
echo "4ï¸âƒ£  Unit tests skipped (test on target device)"

# =============================================================================
# Check 5: TODO Comment Check (DISABLED)
# =============================================================================
echo ""
echo "5ï¸âƒ£  TODO check skipped"

# =============================================================================
# Check 6: Config Migration Warning (DISABLED)
# =============================================================================
echo ""
echo "6ï¸âƒ£  SetConstant() check skipped"

# =============================================================================
# Success!
# =============================================================================
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
